!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(t.braintree||(t.braintree={})).unionpay=e()}}(function(){var e;return function t(e,n,r){function i(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};e[s][0].call(l.exports,function(t){var n=e[s][1][t];return i(n?n:t)},l,l.exports,t,e,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t,n,r){"use strict";!function(t,i){"object"==typeof r&&"undefined"!=typeof n?n.exports=i():"function"==typeof e&&e.amd?e([],i):t.framebus=i()}(this,function(){function e(e){return null==e?!1:null==e.Window?!1:e.constructor!==e.Window?!1:(v.push(e),!0)}function t(e){var t,n={};for(t in b)b.hasOwnProperty(t)&&(n[t]=b[t]);return n._origin=e||"*",n}function n(e){var t,n,r=o(this);return s(e)?!1:s(r)?!1:(n=Array.prototype.slice.call(arguments,1),t=a(e,n,r),t===!1?!1:(h(m.top,t,r),!0))}function r(e,t){var n=o(this);return _(e,t,n)?!1:(g[n]=g[n]||{},g[n][e]=g[n][e]||[],g[n][e].push(t),!0)}function i(e,t){var n,r,i=o(this);if(_(e,t,i))return!1;if(r=g[i]&&g[i][e],!r)return!1;for(n=0;n<r.length;n++)if(r[n]===t)return r.splice(n,1),!0;return!1}function o(e){return e&&e._origin||"*"}function s(e){return"string"!=typeof e}function a(e,t,n){var r=!1,i={event:e,origin:n},o=t[t.length-1];"function"==typeof o&&(i.reply=E(o,n),t=t.slice(0,-1)),i.args=t;try{r=x+JSON.stringify(i)}catch(s){throw new Error("Could not stringify event: "+s.message)}return r}function u(e){var t,n,r,i;if(e.data.slice(0,x.length)!==x)return!1;try{t=JSON.parse(e.data.slice(x.length))}catch(o){return!1}return null!=t.reply&&(n=e.origin,r=e.source,i=t.reply,t.reply=function(e){var t=a(i,[e],n);return t===!1?!1:void r.postMessage(t,n)},t.args.push(t.reply)),t}function c(e){m||(m=e||window,m.addEventListener?m.addEventListener("message",d,!1):m.attachEvent?m.attachEvent("onmessage",d):null===m.onmessage?m.onmessage=d:m=null)}function l(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})}function d(e){var t;s(e.data)||(t=u(e),t&&(p("*",t.event,t.args,e),p(e.origin,t.event,t.args,e),y(e.data,t.origin,e.source)))}function p(e,t,n,r){var i;if(g[e]&&g[e][t])for(i=0;i<g[e][t].length;i++)g[e][t][i].apply(r,n)}function f(e){return e.top!==e?!1:null==e.opener?!1:e.opener===e?!1:e.opener.closed===!0?!1:!0}function h(e,t,n){var r;try{for(e.postMessage(t,n),f(e)&&h(e.opener.top,t,n),r=0;r<e.frames.length;r++)h(e.frames[r],t,n)}catch(i){}}function y(e,t,n){var r,i;for(r=v.length-1;r>=0;r--)i=v[r],i.closed===!0?v=v.slice(r,1):n!==i&&h(i.top,e,t)}function E(e,t){function n(i,o){e(i,o),b.target(t).unsubscribe(r,n)}var r=l();return b.target(t).subscribe(r,n),r}function _(e,t,n){return s(e)?!0:"function"!=typeof t?!0:s(n)?!0:!1}var m,b,v=[],g={},x="/*framebus*/";return c(),b={target:t,include:e,publish:n,pub:n,trigger:n,emit:n,subscribe:r,sub:r,on:r,unsubscribe:i,unsub:i,off:i}})},{}],2:[function(e,t,n){"use strict";var r=e("./lib/set-attributes"),i=e("./lib/default-attributes"),o=e("./lib/assign");t.exports=function(e){var t=document.createElement("iframe"),n=o({},i,e);return n.style&&"string"!=typeof n.style&&(o(t.style,n.style),delete n.style),r(t,n),t.getAttribute("id")||(t.id=t.name),t}},{"./lib/assign":3,"./lib/default-attributes":4,"./lib/set-attributes":5}],3:[function(e,t,n){"use strict";t.exports=function(e){var t=Array.prototype.slice.call(arguments,1);return t.forEach(function(t){"object"==typeof t&&Object.keys(t).forEach(function(n){e[n]=t[n]})}),e}},{}],4:[function(e,t,n){t.exports={src:"about:blank",frameBorder:0,allowtransparency:!0,scrolling:"no"}},{}],5:[function(e,t,n){"use strict";t.exports=function(e,t){var n;for(var r in t)t.hasOwnProperty(r)&&(n=t[r],null==n?e.removeAttribute(r):e.setAttribute(r,n))}},{}],6:[function(e,t,n){"use strict";function r(e,t){var n,r=t?o(t):{},a=i(e.authorization).attrs,u=o(e.analyticsMetadata);r.braintreeLibraryVersion=s.BRAINTREE_LIBRARY_VERSION;for(n in r._meta)r._meta.hasOwnProperty(n)&&(u[n]=r._meta[n]);return r._meta=u,a.tokenizationKey?r.tokenizationKey=a.tokenizationKey:r.authorizationFingerprint=a.authorizationFingerprint,r}var i=e("./create-authorization-data"),o=e("./json-clone"),s=e("./constants");t.exports=r},{"./constants":11,"./create-authorization-data":13,"./json-clone":17}],7:[function(e,t,n){"use strict";function r(e){return Math.floor(e/1e3)}function i(e,t,n){var i=e.getConfiguration(),a=e._request,u=r(Date.now()),c=i.gatewayConfiguration.analytics.url,l={analytics:[{kind:t,timestamp:u}]};a({url:c,method:"post",data:s(i,l),timeout:o.ANALYTICS_REQUEST_TIMEOUT_MS},n)}var o=e("./constants"),s=e("./add-metadata");t.exports={sendEvent:i}},{"./add-metadata":6,"./constants":11}],8:[function(e,t,n){"use strict";function r(e,t){var n,r,o=document.createElement("a");return o.href=t,r="https:"===o.protocol?o.host.replace(/:443$/,""):"http:"===o.protocol?o.host.replace(/:80$/,""):o.host,n=o.protocol+"//"+r,n===e||i.test(e)}var i=/^https:\/\/([a-zA-Z0-9-]+\.)*(braintreepayments|braintreegateway|paypal)\.com(:\d{1,5})?$/;t.exports={checkOrigin:r}},{}],9:[function(e,t,n){"use strict";var r=e("../enumerate");t.exports=r(["CONFIGURATION_REQUEST"],"bus:")},{"../enumerate":15}],10:[function(e,t,n){"use strict";function r(e){if(e=e||{},this.channel=e.channel,!this.channel)throw new a({type:a.types.INTERNAL,message:"Channel ID must be specified."});this.merchantUrl=e.merchantUrl,this._isDestroyed=!1,this._isVerbose=!1,this._listeners=[],this._log("new bus on channel "+this.channel,[location.href])}var i=e("framebus"),o=e("./events"),s=e("./check-origin").checkOrigin,a=e("../error");r.prototype.on=function(e,t){var n,r,o=t,a=this;this._isDestroyed||(this.merchantUrl&&(o=function(){s(this.origin,a.merchantUrl)&&t.apply(this,arguments)}),n=this._namespaceEvent(e),r=Array.prototype.slice.call(arguments),r[0]=n,r[1]=o,this._log("on",r),i.on.apply(i,r),this._listeners.push({eventName:e,handler:o,originalHandler:t}))},r.prototype.emit=function(e){var t;this._isDestroyed||(t=Array.prototype.slice.call(arguments),t[0]=this._namespaceEvent(e),this._log("emit",t),i.emit.apply(i,t))},r.prototype._offDirect=function(e){var t=Array.prototype.slice.call(arguments);this._isDestroyed||(t[0]=this._namespaceEvent(e),this._log("off",t),i.off.apply(i,t))},r.prototype.off=function(e,t){var n,r,i=t;if(!this._isDestroyed){if(this.merchantUrl)for(n=0;n<this._listeners.length;n++)r=this._listeners[n],r.originalHandler===t&&(i=r.handler);this._offDirect(e,i)}},r.prototype._namespaceEvent=function(e){return["braintree",this.channel,e].join(":")},r.prototype.teardown=function(){var e,t;for(t=0;t<this._listeners.length;t++)e=this._listeners[t],this._offDirect(e.eventName,e.handler);this._listeners.length=0,this._isDestroyed=!0},r.prototype._log=function(e,t){this._isVerbose&&console.log(e,t)},r.events=o,t.exports=r},{"../error":16,"./check-origin":8,"./events":9,framebus:1}],11:[function(e,t,n){"use strict";var r="3.0.0-beta.8",i="web";t.exports={ANALYTICS_REQUEST_TIMEOUT_MS:2e3,INTEGRATION_TIMEOUT_MS:6e4,VERSION:r,INTEGRATION:"custom",SOURCE:"client",PLATFORM:i,BRAINTREE_LIBRARY_VERSION:"braintree/"+i+"/"+r}},{}],12:[function(e,t,n){"use strict";var r=e("./error");t.exports=function(e,t){t.forEach(function(t){e[t]=function(){throw new r({type:r.types.MERCHANT,message:t+" cannot be called after teardown."})}})}},{"./error":16}],13:[function(e,t,n){"use strict";function r(e){return/^[a-zA-Z0-9]+_[a-zA-Z0-9]+_[a-zA-Z0-9_]+$/.test(e)}function i(e){var t=e.split("_"),n=t[0],r=t.slice(2).join("_");return{merchantId:r,environment:n}}function o(e){var t,n,o={attrs:{},configUrl:""};return r(e)?(n=i(e),o.attrs.tokenizationKey=e,o.configUrl=a[n.environment]+"/merchants/"+n.merchantId+"/client_api/v1/configuration"):(t=JSON.parse(s(e)),o.attrs.authorizationFingerprint=t.authorizationFingerprint,o.configUrl=t.configUrl),o}var s=e("../lib/polyfill").atob,a={production:"https://api.braintreegateway.com:443",sandbox:"https://api.sandbox.braintreegateway.com:443"};t.exports=o},{"../lib/polyfill":19}],14:[function(e,t,n){"use strict";t.exports=function(e){return function(){var t=arguments;setTimeout(function(){e.apply(null,t)},1)}}},{}],15:[function(e,t,n){"use strict";function r(e,t){return t=null==t?"":t,e.reduce(function(e,n){return e[n]=t+n,e},{})}t.exports=r},{}],16:[function(e,t,n){"use strict";function r(e){if(!r.types.hasOwnProperty(e.type))throw new Error(e.type+" is not a valid type.");if(!e.message)throw new Error("Error message required.");this.message=e.message,this.type=e.type,this.details=e.details}var i=e("./enumerate");r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r.types=i(["CUSTOMER","MERCHANT","NETWORK","INTERNAL","UNKNOWN"]),t.exports=r},{"./enumerate":15}],17:[function(e,t,n){"use strict";t.exports=function(e){return JSON.parse(JSON.stringify(e))}},{}],18:[function(e,t,n){"use strict";t.exports=function(e){return Object.keys(e).filter(function(t){return"function"==typeof e[t]})}},{}],19:[function(e,t,n){(function(e){"use strict";function n(e){var t,n,r,i,o,s,a,u,c=new RegExp("^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$"),l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="";if(!c.test(e))throw new Error("Non base64 encoded input passed to window.atob polyfill");u=0;do i=l.indexOf(e.charAt(u++)),o=l.indexOf(e.charAt(u++)),s=l.indexOf(e.charAt(u++)),a=l.indexOf(e.charAt(u++)),t=(63&i)<<2|o>>4&3,n=(15&o)<<4|s>>2&15,r=(3&s)<<6|63&a,d+=String.fromCharCode(t)+(n?String.fromCharCode(n):"")+(r?String.fromCharCode(r):"");while(u<e.length);return d}var r="function"==typeof e.atob?e.atob:n;t.exports={atob:r,_atob:n}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],20:[function(e,t,n){"use strict";function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})}t.exports=r},{}],21:[function(e,t,n){"use strict";function r(e,t){var n,r;if("function"!=typeof t)throw new s({type:s.types.MERCHANT,message:"UnionPay creation requires a callback."});return t=u(t),null==e.client?void t(new s({type:s.types.MERCHANT,message:"options.client is required when instantiating UnionPay."})):(n=e.client.getConfiguration(),r=n.analyticsMetadata.sdkVersion,r!==i?void t(new s({type:s.types.MERCHANT,message:"Client (version "+r+") and UnionPay (version "+i+") components must be from the same SDK version."})):n.gatewayConfiguration.unionPay&&n.gatewayConfiguration.unionPay.enabled===!0?(a.sendEvent(e.client,"web.unionpay.initialized"),void t(null,new o(e))):void t(new s({type:s.types.MERCHANT,message:"UnionPay is not enabled for this merchant."})))}var i="3.0.0-beta.8",o=e("./shared/unionpay"),s=e("../lib/error"),a=e("../lib/analytics"),u=e("../lib/deferred");t.exports={create:r,VERSION:i}},{"../lib/analytics":7,"../lib/deferred":14,"../lib/error":16,"./shared/unionpay":23}],22:[function(e,t,n){"use strict";var r=e("../../lib/enumerate");t.exports={events:r(["HOSTED_FIELDS_FETCH_CAPABILITIES","HOSTED_FIELDS_ENROLL","HOSTED_FIELDS_TOKENIZE"],"union-pay:"),HOSTED_FIELDS_FRAME_NAME:"braintreeunionpayhostedfields",INVALID_HOSTED_FIELDS_ERROR_MESSAGE:"Found an invalid Hosted Fields instance. Please use a valid Hosted Fields instance.",CARD_OR_HOSTED_FIELDS_REQUIRED_ERROR_MESSAGE:"A card or a Hosted Fields instance is required. Please supply a card or a Hosted Fields instance.",CARD_AND_HOSTED_FIELDS_ERROR_MESSAGE:"Please supply either a card or a Hosted Fields instance, not both.",NO_HOSTED_FIELDS_ERROR_MESSAGE:"Could not find the Hosted Fields instance."}},{"../../lib/enumerate":15}],23:[function(e,t,n){"use strict";function r(e){this._options=e}var i=e("../../lib/error"),o=e("../../lib/bus"),s=e("../../lib/analytics"),a=e("iframer"),u=e("../../lib/uuid"),c=e("../../lib/methods"),l=e("../../lib/deferred"),d=e("../../lib/convert-methods-to-error"),p="3.0.0-beta.8",f=e("./constants"),h=f.events;r.prototype.fetchCapabilities=function(e,t){var n=this._options.client,r=e.card?e.card.number:null,o=e.hostedFields;if(t=l(t),r&&o)return void t(new i({type:i.types.MERCHANT,message:f.CARD_AND_HOSTED_FIELDS_ERROR_MESSAGE}));if(r)n.request({method:"get",endpoint:"payment_methods/credit_cards/capabilities",data:{_meta:{source:"unionpay"},creditCard:{number:r}}},function(e,r){return e?(t(new i({type:i.types.NETWORK,message:"Fetch capabilities network error.",details:{originalError:e}})),void s.sendEvent(n,"web.unionpay.capabilities-failed")):(s.sendEvent(n,"web.unionpay.capabilities-received"),void t(null,r))});else{if(!o)return void t(new i({type:i.types.MERCHANT,message:f.CARD_OR_HOSTED_FIELDS_REQUIRED_ERROR_MESSAGE}));if(!o._bus)return void t(new i({type:i.types.MERCHANT,message:f.INVALID_HOSTED_FIELDS_ERROR_MESSAGE}));this._initializeHostedFields(function(){this._bus.emit(h.HOSTED_FIELDS_FETCH_CAPABILITIES,{hostedFields:o},function(e){return e.err?void t(new i(e.err)):void t(null,e.payload)})}.bind(this))}},r.prototype.enroll=function(e,t){var n,r=this._options.client,o=e.card,a=e.mobile,u=e.hostedFields;if(t=l(t),!a)return void t(new i({type:i.types.MERCHANT,message:"A `mobile` with `countryCode` and `number` is required."}));if(u){if(!u._bus)return void t(new i({type:i.types.MERCHANT,message:f.INVALID_HOSTED_FIELDS_ERROR_MESSAGE}));if(o)return void t(new i({type:i.types.MERCHANT,message:f.CARD_AND_HOSTED_FIELDS_ERROR_MESSAGE}));this._initializeHostedFields(function(){this._bus.emit(h.HOSTED_FIELDS_ENROLL,{hostedFields:u,mobile:a},function(e){return e.err?void t(new i(e.err)):void t(null,e.payload)})}.bind(this))}else{if(!o||!o.number)return void t(new i({type:i.types.MERCHANT,message:f.CARD_OR_HOSTED_FIELDS_REQUIRED_ERROR_MESSAGE}));if(n={_meta:{source:"unionpay"},unionPayEnrollment:{number:o.number,mobileCountryCode:a.countryCode,mobileNumber:a.number}},o.expirationMonth||o.expirationYear){if(!o.expirationMonth||!o.expirationYear)return void t(new i({type:i.types.MERCHANT,message:"You must supply expiration month and year or neither."}));n.unionPayEnrollment.expirationYear=o.expirationYear,n.unionPayEnrollment.expirationMonth=o.expirationMonth}r.request({method:"post",endpoint:"union_pay_enrollments",data:n},function(e,n,o){var a,u;return e?(500>o?(u=i.types.CUSTOMER,a="Enrollment invalid due to customer input error."):(u=i.types.NETWORK,a="An enrollment network error occurred."),s.sendEvent(r,"web.unionpay.enrollment-failed"),void t(new i({type:u,message:a,details:{originalError:e}}))):(s.sendEvent(r,"web.unionpay.enrollment-succeeded"),void t(null,{enrollmentId:n.unionPayEnrollmentId}))})}},r.prototype.tokenize=function(e,t){var n,r,o=this._options.client,a=e.card,u=e.hostedFields;if(t=l(t),a&&u)return void t(new i({type:i.types.MERCHANT,message:f.CARD_AND_HOSTED_FIELDS_ERROR_MESSAGE}));if(a)n={_meta:{source:"unionpay"},creditCard:{number:e.card.number,expirationMonth:e.card.expirationMonth,expirationYear:e.card.expirationYear,options:{unionPayEnrollment:{id:e.enrollmentId,smsCode:e.smsCode}}}},e.card.cvv&&(n.creditCard.cvv=e.card.cvv),o.request({method:"post",endpoint:"payment_methods/credit_cards",data:n},function(e,n,a){return e?(s.sendEvent(o,"web.unionpay.nonce-failed"),void t(500>a?new i({type:i.types.CUSTOMER,message:"The supplied card data failed tokenization.",details:{originalError:e}}):new i({type:i.types.NETWORK,message:"A tokenization network error occurred.",details:{originalError:e}}))):(r=n.creditCards[0],delete r.consumed,delete r.threeDSecureInfo,delete r.type,s.sendEvent(o,"web.unionpay.nonce-received"),void t(null,r))});else{if(!u)return void t(new i({type:i.types.MERCHANT,message:f.CARD_OR_HOSTED_FIELDS_REQUIRED_ERROR_MESSAGE}));if(!u._bus)return void t(new i({type:i.types.MERCHANT,message:f.INVALID_HOSTED_FIELDS_ERROR_MESSAGE}));this._initializeHostedFields(function(){this._bus.emit(h.HOSTED_FIELDS_TOKENIZE,e,function(e){return e.err?void t(new i(e.err)):void t(null,e.payload)})}.bind(this))}},r.prototype.teardown=function(e){this._bus&&(this._hostedFieldsFrame.parentNode.removeChild(this._hostedFieldsFrame),this._bus.teardown()),d(this,c(r.prototype)),"function"==typeof e&&(e=l(e))()},r.prototype._initializeHostedFields=function(e){var t=u();return this._bus?void e():(this._bus=new o({channel:t,merchantUrl:location.href}),this._hostedFieldsFrame=a({name:f.HOSTED_FIELDS_FRAME_NAME+"_"+t,src:this._options.client.getConfiguration().gatewayConfiguration.assetsUrl+"/web/"+p+"/html/unionpay-hosted-fields-frame.min.html",height:0,width:0}),this._bus.on(o.events.CONFIGURATION_REQUEST,function(t){t(this._options.client),e()}.bind(this)),void document.body.appendChild(this._hostedFieldsFrame))},t.exports=r},{"../../lib/analytics":7,"../../lib/bus":10,"../../lib/convert-methods-to-error":12,"../../lib/deferred":14,"../../lib/error":16,"../../lib/methods":18,"../../lib/uuid":20,"./constants":22,iframer:2}]},{},[21])(21)});
